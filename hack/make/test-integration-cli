#!/bin/bash
set -e

bundle_test_integration_cli() {
	TESTFLAGS+=" -check.v -check.timeout=${TIMEOUT} -test.timeout=360m"
	(
		cd integration-cli
		if [ "$HAVE_GO_TEST_COVER" ]; then
			# '-args -test.coverprofile "cover.out"' does not work for integration-cli. so we need this line.
			TESTFLAGS+=" -coverprofile cover.out"
		fi
		export DEST="$ABS_DEST" # we're in a subshell, so this is safe -- our integration-cli tests need DEST, and "cd" screws it up
		go_test_pkgs .
	)
}

# subshell so that we can export PATH without breaking other things
(
	bundle .integration-daemon-start

	bundle .integration-daemon-setup

	bundle_test_integration_cli

	bundle .integration-daemon-stop
) 2>&1 | tee -a "$DEST/test.log"
