#!/usr/bin/env bash

rm -rf autogen/*

source hack/dockerfile/install/runc.installer
source hack/dockerfile/install/tini.installer
source hack/dockerfile/install/containerd.installer

LDFLAGS="${LDFLAGS} \
	-X \"github.com/docker/docker/dockerversion.Version=${VERSION}\" \
	-X \"github.com/docker/docker/dockerversion.GitCommit=${GITCOMMIT}\" \
	-X \"github.com/docker/docker/dockerversion.BuildTime=${BUILDTIME}\" \
	-X \"github.com/docker/docker/dockerversion.IAmStatic=${IAMSTATIC:-true}\" \
	-X \"github.com/docker/docker/dockerversion.PlatformName=${PLATFORM}\" \
	-X \"github.com/docker/docker/dockerversion.ProductName=${PRODUCT}\" \
	-X \"github.com/docker/docker/dockerversion.DefaultProductLicense=${DEFAULT_PRODUCT_LICENSE}\" \
"

# Compile the Windows resources into the sources
if [ "$(go env GOOS)" = "windows" ]; then
	TEMPDIR=$(mktemp -d)
	trap 'rm -rf "$TEMPDIR"' EXIT

	mkdir -p autogen/winresources/dockerd
	cp hack/make/.resources-windows/resources.go autogen/winresources/dockerd/

	if [ "$(go env GOHOSTOS)" = "windows" ]; then
		WINDRES=windres
		WINDMC=windmc
	else
		# Cross compiling
		WINDRES=x86_64-w64-mingw32-windres
		WINDMC=x86_64-w64-mingw32-windmc
	fi

	# Generate a Windows file version of the form major,minor,patch,build (with any part optional)
	if [ -z "$VERSION_QUAD" ]; then
		VERSION_QUAD=$(printf "%s" "$VERSION" | sed -re 's/^([0-9.]*).*$/\1/' | tr . ,)
	fi

	# Pass version and commit information into the resource compiler
	defs=()
	[ -n "$VERSION" ]       && defs+=("-D") && defs+=("DOCKER_VERSION=\"$VERSION\"")
	[ -n "$VERSION_QUAD" ]  && defs+=("-D") && defs+=("DOCKER_VERSION_QUAD=\"$VERSION_QUAD\"")
	[ -n "$GITCOMMIT" ]     && defs+=("-D") && defs+=("DOCKER_COMMIT=\"$GITCOMMIT\"")
#	[ -n "$PACKAGER_NAME" ] && defs+=("-D") && defs+=("PACKAGER_NAME=\"FOOBAR HELLO\"")

	makeres() {
		set -x
		# shellcheck disable=SC2086
		"${WINDRES}" \
			-i "hack/make/.resources-windows/$1" \
			-o "$3" \
			-F "$2" \
			--use-temp-file \
			-I "$TEMPDIR" \
			"${defs[@]}"
	}

	"${WINDMC}" \
		hack/make/.resources-windows/event_messages.mc \
		-h "$TEMPDIR" \
		-r "$TEMPDIR"

	makeres dockerd.rc pe-x86-64 autogen/winresources/dockerd/rsrc_amd64.syso
fi
